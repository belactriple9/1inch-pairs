<!DOCTYPE html>
<html>

<head>
    <script type="text/json"
        src="https://cdn.jsdelivr.net/npm/@1inch/limit-order-protocol@1.3.0/abi/LimitOrderProtocol.json"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.6/dist/web3.min.js" type="text/javascript"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

    <script>

        const delay = ms => new Promise(res => setTimeout(res, ms));

        localStorage.setItem("page", 1);
        !(localStorage.getItem("pairs") == null) ? null : localStorage.setItem("pairs", "{}");

        let chain = 1; //it's 1 by default
        !(localStorage.getItem("tokenlistEth") == null) ? null : localStorage.setItem("tokenlistEth", "{}");
        let tokenlistEth = JSON.parse(localStorage.tokenlistEth);
        !(localStorage.getItem("tokenlistBsc") == null) ? null : localStorage.setItem("tokenlistBsc", "{}");
        let tokenlistBsc = JSON.parse(localStorage.tokenlistBsc);
        !(localStorage.getItem("tokenlistPoly") == null) ? null : localStorage.setItem("tokenlistPoly", "{}");
        let tokenlistPoly = JSON.parse(localStorage.tokenlistPoly);
        // let provider;
        // let signer;
        let abi = [
            // Read-Only Functions
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"];

        const ethkey = "Q8REX89H46RIPXG6MBA6QXEAGI4B11MW5A";
        const bsckey = "5ZZV5686GVZ6D9ZY5QCZPJ56J6HBIPFIG1";
        const polykey = "T3C4VRZJUHU96HRM38ZB79BQRENR5VZN76";
        const infurakey = "52aee165600a40718b05b78def0c0212";
        const matickey = "f62616deb8a61369fca6066adc6e71858f8f36b3";


        let ethProvider = new ethers.providers.JsonRpcProvider("https://mainnet.infura.io/v3/" + infurakey)
        let bscProvider = new ethers.providers.JsonRpcProvider("https://bsc-dataseed.binance.org/");
        let polyProvider = new ethers.providers.JsonRpcProvider("https://rpc-mainnet.maticvigil.com/v1/" + matickey)

        $.ajax({ method: "GET", dataType: "json", url: "https://tokens.1inch.exchange/v1.1/1" }).done((ret) => {
            for (var item in ret) {
                if (!tokenlistEth.hasOwnProperty(ret[item].address));
                tokenlistEth[ret[item].address] = { "symbol": ret[item].symbol, "decimals": ret[item].decimals }
            }
            localStorage.tokenlistEth = JSON.stringify(tokenlistEth); //save the token list
        })

        $.ajax({ method: "GET", dataType: "json", url: "https://tokens.1inch.exchange/v1.1/56" }).done((ret) => {
            for (var item in ret) {
                if (!tokenlistBsc.hasOwnProperty(ret[item].address));
                tokenlistBsc[ret[item].address] = { "symbol": ret[item].symbol, "decimals": ret[item].decimals }
            }
            localStorage.tokenlistBsc = JSON.stringify(tokenlistBsc); //save the token list
        })

        $.ajax({ method: "GET", dataType: "json", url: "https://tokens.1inch.exchange/v1.1/137" }).done((ret) => {
            for (var item in ret) {
                if (!tokenlistPoly.hasOwnProperty(ret[item].address));
                tokenlistPoly[ret[item].address] = { "symbol": ret[item].symbol, "decimals": ret[item].decimals }
            }
            localStorage.tokenlistPoly = JSON.stringify(tokenlistPoly); //save the token list
        })

        $(() => {

            reloadPage();

            $('#next').on('click', (e) => {
                e.preventDefault();
                localStorage.setItem("page", Number.parseInt(localStorage.getItem("page")) + 1);
                $('#page-number').text(localStorage.getItem("page"));
                reloadPage();
            })
            $('#previous').on('click', (e) => {
                e.preventDefault();
                if (localStorage.getItem("page") > 1)
                    localStorage.setItem("page", Number.parseInt(localStorage.getItem("page")) - 1);
                $('#page-number').text(localStorage.getItem("page"));
                reloadPage();
            })


            $('#search-btn').on('click', (e) => {
                e.preventDefault(); //*CRITICAL* : this "catches" the form submit event and stops it

                async function driver() {
                    let fromToken = document.getElementById("FromToken").value;
                    let toToken = document.getElementById("ToToken").value;

                    let address = document.getElementById("address").value;

                    chain = document.getElementById("drop-down").value;

                    $('#results').text(""); //delete results
                    try {
                        await $.ajax({ method: "GET", url: "https://apiv4.paraswap.io/v2/tokens/" + chain }).done((ret) => {
                            tokenlist = ret.tokens;
                        })
                    }
                    catch (e) {
                        //tokenlist fallback
                        try {
                            await $.ajax({ method: "GET", url: "https://tokens.1inch.exchange/v1.1/" + chain }).done((ret) =>
                                tokenlist = ret)
                        } catch (e) {
                            alert("an error has occured, orders may not load");
                        }
                    }

                    if (fromToken != "" || toToken != "") {
                        getLOPairList(fromToken, toToken, chain); //get new results
                    }
                    if (address != "")
                        getAddressLOList(address, chain)


                }

                function getLOPairList(fromToken, toToken, chain) {
                    let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/all?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%2C2%2C3%5D&sortBy=takerRate&takerAsset=" + toToken + "&makerAsset=" + fromToken;
                    $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                        //console.log(ret);
                        parseLOPairResults(ret, fromToken, toToken, chain);
                    })

                }

                async function parseLOPairResults(orders, fromToken, toToken, chain) {

                    let tokenInfo = "";
                    let url = "";
                    let fromTokenIndex = -2;
                    let toTokenIndex = -2;
                    for (var i = 0; i < orders.length; i++) {
                        //if ((fromToken != orders[i].data.makerAsset || toToken != orders[i].data.takerAsset) || tokenInfo === "") {
                        displayInfo = "";
                        fromTokenIndex = -1;
                        toTokenIndex = -1;
                        if (fromToken != orders[i].data.makerAsset) {
                            fromToken = orders[i].data.makerAsset;
                        }
                        if (toToken != orders[i].data.takerAsset) {
                            toToken = orders[i].data.takerAsset;
                        }





                        try {
                            url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=' + orders[i].makerAmount;


                            await $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                                tokenInfo = ret;

                                let toTokenInfo = orders[i].data.takerAsset == ret.fromToken.address ? ret.fromToken : ret.toToken;
                                let fromTokenInfo = orders[i].data.makerAsset == ret.toToken.address ? ret.toToken : ret.fromToken;

                                displayInfo += "MakerAmount: " + (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)).toFixed(fromTokenInfo.decimals > 4 ? 4 : 0) + " " + fromTokenInfo.symbol + "\n";
                                displayInfo += "TakerAmount: " + (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)).toFixed(toTokenInfo.decimals > 4 ? 4 : 0) + " " + toTokenInfo.symbol + "\n";
                                let makerRate = (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)) / (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals));
                                let takerRate = (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)) / (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals));
                                displayInfo += "TakerRate: " + takerRate + " " + toTokenInfo.symbol + " per 1 " + fromTokenInfo.symbol + "\n";
                                displayInfo += "MakerRate: " + makerRate + " " + fromTokenInfo.symbol + " per 1 " + toTokenInfo.symbol + "\n";

                                displayInfo += "Left to Fill: ";
                                displayInfo += orders[i].remainingMakerAmount / Math.pow(10, fromTokenInfo.decimals) + " " + fromTokenInfo.symbol + "\n"

                                $('#results').append(displayInfo + '<hr>');
                            })


                        }
                        catch (e) {
                            //alert("Flipping")
                            try {
                                url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?fromTokenAddress=' + toToken + '&toTokenAddress=' + fromToken + '&amount=' + orders[i].makerAmount;
                                await $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                                    tokenInfo = ret;

                                    let fromTokenInfo = orders[i].data.makerAsset == ret.toToken.address ? ret.toToken : ret.fromToken;
                                    let toTokenInfo = orders[i].data.takerAsset == ret.fromToken.address ? ret.fromToken : ret.toToken;

                                    displayInfo += "MakerAmount: " + (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)).toFixed(fromTokenInfo.decimals > 4 ? 4 : 0) + " " + fromTokenInfo.symbol + "\n";
                                    displayInfo += "TakerAmount: " + (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)).toFixed(toTokenInfo.decimals > 4 ? 4 : 0) + " " + toTokenInfo.symbol + "\n";
                                    let makerRate = (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)) / (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals));
                                    let takerRate = (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)) / (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals));
                                    displayInfo += "MakerRate: " + makerRate + " " + toTokenInfo.symbol + " per 1 " + fromTokenInfo.symbol + "\n";
                                    displayInfo += "TakerRate: " + takerRate + " " + fromTokenInfo.symbol + " per 1 " + toTokenInfo.symbol + "\n";

                                    displayInfo += "Left to Fill: ";
                                    displayInfo += orders[i].remainingMakerAmount / Math.pow(10, fromTokenInfo.decimals) + " " + fromTokenInfo.symbol + "\n"

                                    $('#results').append(displayInfo + '<hr>');

                                })
                            } catch (e) { $('#results').append("Unable to find token info for " + toToken + " to " + fromToken + '<hr>'); }
                        }

                    }

                }

                function getAddressLOList(address, chain) {
                    let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/address/" + address + "?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%2C2%5D"
                    $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                        console.log(ret);
                        parseAddressLOResults(ret, address, chain);
                    })
                }

                async function parseAddressLOResults(orders, address, chain) {
                    let fromToken;
                    let toToken;
                    let url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?' //'fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=1000000000000000000'
                    let tokenInfo;

                    let scan = getBlockchainScannerForToken(chain);

                    for (let i = 0; i < orders.length; i++) {


                        //if (fromToken != orders[i].data.makerAsset && toToken != orders[i].data.takerAsset) {
                        if (fromToken != orders[i].data.makerAsset)
                            fromToken = orders[i].data.makerAsset;
                        if (toToken != orders[i].data.takerAsset)
                            toToken = orders[i].data.takerAsset;
                        try {
                            if (tokenlist[tokenlist.findIndex(item => item.address === orders[i].data.makerAsset)].decimals < 18) //if the maker token has less than 18 dcimals
                                orders[i].remainingMakerAmount = (orders[i].remainingMakerAmount * Math.pow(10, 18 - orders[i].fromTokenInfo.decimals)); //pad until 18 decimals
                        } catch (e) {
                            console.log("Can't pad, assuming makerAmount has 18 decimals");
                        }

                        if ( //if offerRecieve fails, try the next
                            await offerRecieve(url, toToken, fromToken, orders[i].remainingMakerAmount, orders[i], scan)
                        ) {
                            if (
                                await offerRecieveFlipped(url, toToken, fromToken, orders[i].remainingMakerAmount, orders[i], scan)
                            ) {
                                $('#results').append("Unable to find token info for " + toToken + " to " + fromToken + '<hr>');
                            }
                        }
                    }
                }

                async function offerRecieve(url, toToken, fromToken, amount, orderData, chainURL) {
                    let displayInfo = "";
                    try {
                        await $.ajax({ method: "GET", dataType: "json", url: url + 'fromTokenAddress=' + toToken + '&toTokenAddress=' + fromToken + '&amount=' + amount }).done((ret) => {
                            console.log(ret);
                            tokenInfo = ret;

                            displayInfo += "Your Offer: " + (orderData.takerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                                + " <a href=\"" + chainURL + toToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                            displayInfo += "You Recieve: " + (orderData.makerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                                + " <a href=\"" + chainURL + fromToken + "\">" + tokenInfo.toToken.symbol + "</a>" + "\n";

                            displayInfo += "Left to Fill: " + amount / Math.pow(10, tokenInfo.fromToken.decimals) + " " + tokenInfo.fromToken.symbol + "\n";
                            //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orderData.data) + ">Cancel order?</button>\n";

                            $('#results').append(displayInfo + '<hr>');
                        })
                    }
                    catch (e) {
                        return true; //return true upon failure
                    }
                    return false; //return false if it works
                }

                async function offerRecieveFlipped(url, toToken, fromToken, amount, orderData, chainURL) {
                    let displayInfo = "";
                    console.log("Flipping quote");
                    try {
                        await $.ajax({ method: "GET", dataType: "json", url: url + 'fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=' + amount }).done((ret) => {
                            console.log(ret);
                            tokenInfo = ret;

                            displayInfo += "Your Offer: " + (orderData.makerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                                + " <a href=\"" + chainURL + toToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                            displayInfo += "You Recieve: " + (orderData.takerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                                + " <a href=\"" + chainURL + fromToken + "\">" + tokenInfo.toToken.symbol + "</a>" + "\n";


                            displayInfo += "Left to Fill: " + amount / Math.pow(10, tokenInfo.fromToken.decimals) + " " + tokenInfo.fromToken.symbol + "\n";
                            //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orderData.data) + ">Cancel order?</button>\n";

                            $('#results').append(displayInfo + '<hr>');
                        })
                    } catch (e) {
                        return true; //return true upon failure
                    }
                    return false; //return false if it works
                }

                function getBlockchainScannerForToken(chain) {
                    switch (chain) {
                        case "1": return "https://etherscan.io/token/"
                            break;
                        case "56": return "https://bscscan.com/token/"
                            break;
                        case "137": return "https://polygonscan.com/token/"
                            break;
                    }
                }

                driver();
            })

            $("#FromToken").change(async (e) => {
                let temp = $("#FromToken")[0].value;
                //console.log($("#FromToken"));
                //alert("Triggered From token update " + temp);
                if (temp.length == 42) {
                    reloadPage();
                }
            })

            $("#ToToken").change(e => {
                let temp = $("#ToToken")[0].value;

                if (temp.length == 42)
                    reloadPage();
            })


            function reloadPage() {
                $("#pair-list").empty(); //clear children

                let fromToken = $("#FromToken")[0].value;
                let toToken = $("#ToToken")[0].value;
                fromToken.length == 42 ? null : fromToken = "";
                toToken.length == 42 ? null : toToken = "";
                //Maybe we should verify the token exists on the selected chain?

                // alert(fromToken);
                // alert(toToken);
                let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/all?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%5D&sortBy=createDateTime&takerAsset=" + toToken + "&makerAsset=" + fromToken; //unspecified tokens to just load "random" orders
                $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                    console.log(ret);
                    loadPairs(ret, chain);
                    loadOrders(ret, chain);
                    loadTokenList(chain);

                })
            }

            /**
             * copy of the function that runs on page load
             */
            async function loadPairs(orders, chain) {
                let currentList = JSON.parse(localStorage.pairs);
                let provider;
                //decide the provider
                switch (chain) {
                    case 1:
                        provider = ethProvider;
                        break;
                    case 56:
                        provider = bscProvider;
                        break;
                    case 137:
                        provider = polyProvider;
                        break;

                }

                let tokenInfo = "";
                let url = "";
                let fromToken;
                let toToken;
                let fromTokenInfo;
                let toTokenInfo;
                for (var i = 0; i < orders.length; i++) {
                    orderInfo = ""; //this will be used to display on orders
                    pairInfo = ""; //this will be used to display on the pair-list
                    if (fromToken != orders[i].data.makerAsset) {
                        fromToken = orders[i].data.makerAsset;
                    }
                    if (toToken != orders[i].data.takerAsset) {
                        toToken = orders[i].data.takerAsset;
                    }

                    let fromTokenContract// = await new ethers.Contract(fromToken, abi, provider);
                    let toTokenContract// = await new ethers.Contract(toToken, abi, provider);
                    let fromTokenSymbol// = await fromTokenContract.symbol();
                    let fromTokenDecimals// = await fromTokenContract.decimals();
                    let toTokenSymbol// = await toTokenContract.symbol();
                    let toTokenDecimals// = await toTokenContract.decimals();

                    //absolute mess
                    switch (chain) {
                        case 1:
                            if (tokenlistEth.hasOwnProperty(fromToken)) {
                                fromTokenSymbol = tokenlistEth[fromToken].symbol
                                fromTokenDecimals = tokenlistEth[fromToken].decimals
                            }
                            else {
                                fromTokenContract = await new ethers.Contract(fromToken, abi, provider);
                                fromTokenSymbol = await fromTokenContract.symbol();
                                fromTokenDecimals = await fromTokenContract.decimals();
                                //build and add to list
                                fromTokenInfo = { "symbol": fromTokenSymbol, "decimals": fromTokenDecimals };
                                tokenlistEth[fromToken] = fromTokenInfo;

                            }
                            if (tokenlistEth.hasOwnProperty(toToken)) {
                                toTokenSymbol = tokenlistEth[toToken].symbol
                                toTokenDecimals = tokenlistEth[toToken].decimals
                            }
                            else {
                                toTokenContract = await new ethers.Contract(toToken, abi, provider);
                                toTokenSymbol = await toTokenContract.symbol();
                                toTokenDecimals = await toTokenContract.decimals();
                                //build and add to list
                                toTokenInfo = { "symbol": toTokenSymbol, "decimals": toTokenDecimals };
                                tokenlistEth[toToken] = toTokenInfo
                            }
                            break;
                        case 56:
                            if (tokenlistBsc.hasOwnProperty(fromToken)) {
                                fromTokenSymbol = tokenlistBsc[fromToken].symbol
                                fromTokenDecimals = tokenlistBsc[fromToken].decimals
                            } else {
                                fromTokenContract = await new ethers.Contract(fromToken, abi, provider);
                                fromTokenSymbol = await fromTokenContract.symbol();
                                fromTokenDecimals = await fromTokenContract.decimals();
                                //build and add to list
                                fromTokenInfo = { "symbol": fromTokenSymbol, "decimals": fromTokenDecimals };
                                tokenlistBsc[fromToken] = fromTokenInfo;
                            }
                            if (tokenlistBsc.hasOwnProperty(toToken)) {
                                toTokenSymbol = tokenlistBsc[toToken].symbol
                                toTokenDecimals = tokenlistBsc[toToken].decimals
                            } else {
                                toTokenContract = await new ethers.Contract(toToken, abi, provider);
                                toTokenSymbol = await toTokenContract.symbol();
                                toTokenDecimals = await toTokenContract.decimals();
                                //build and add to list
                                toTokenInfo = { "symbol": toTokenSymbol, "decimals": toTokenDecimals };
                                tokenlistBsc[toToken] = toTokenInfo
                            }
                            break;
                        case 137:
                            if (tokenlistPoly.hasOwnProperty(fromToken)) {
                                fromTokenSymbol = tokenlistPoly[fromToken].symbol
                                fromTokenDecimals = tokenlistPoly[fromToken].decimals
                            } else {
                                fromTokenContract = await new ethers.Contract(fromToken, abi, provider);
                                fromTokenSymbol = await fromTokenContract.symbol();
                                fromTokenDecimals = await fromTokenContract.decimals();
                                //build and add to list
                                fromTokenInfo = { "symbol": fromTokenSymbol, "decimals": fromTokenDecimals };
                                tokenlistPoly[fromToken] = fromTokenInfo;
                            }
                            if (tokenlistPoly.hasOwnProperty(toToken)) {
                                toTokenSymbol = tokenlistPoly[toToken].symbol
                                toTokenDecimals = tokenlistPoly[toToken].decimals
                            } else {
                                toTokenContract = await new ethers.Contract(toToken, abi, provider);
                                toTokenSymbol = await toTokenContract.symbol();
                                toTokenDecimals = await toTokenContract.decimals();
                                //build and add to list
                                toTokenInfo = { "symbol": toTokenSymbol, "decimals": toTokenDecimals };
                                tokenlistPoly[toToken] = toTokenInfo
                            }
                            break;
                    }

                    fromTokenInfo = { "symbol": fromTokenSymbol, "decimals": fromTokenDecimals };
                    toTokenInfo = { "symbol": toTokenSymbol, "decimals": toTokenDecimals };

                    let pairObject = { "fromToken": fromTokenInfo, "toToken": toTokenInfo }
                    let pairContract = fromToken + "-" + toToken
                    if (!(currentList.hasOwnProperty(pairContract))) {

                        // delay(200); //previously required for etherscan api
                        currentList[pairContract] = pairObject; //should make this the symbol?
                    }


                }
                //save all the *new* pairs
                localStorage.setItem('pairs', JSON.stringify(currentList));
                let makerToken = $('#FromToken')[0].value;
                let takerToken = $('#ToToken')[0].value;
                alert(makerToken + " - " + takerToken);
                let makerTokenMatches;
                let takerTokenMatches;
                let eitherTokenMatches;
                let bothTokensNull;
                let bothMatch;

                for (const key in currentList) {
                    //alert(key.substring(43) + " " + key.substring(0, 42));

                    makerTokenMatches = key.substring(43) == makerToken && takerToken == "";
                    takerTokenMatches = key.substring(0, 42) == takerToken && makerToken == "";
                    eitherTokenMatches = makerTokenMatches || takerTokenMatches;
                    bothTokensNull = (makerToken == "" && takerToken == "");
                    bothMatch = (key.substring(43) == makerToken && key.substring(0, 42) == takerToken);

                    //console.log("eitherTokenMatches " + eitherTokenMatches + " bothTokensNull " + bothTokensNull + " bothTokensMatch " + bothMatch)

                    if ((eitherTokenMatches && !bothMatch) || bothTokensNull || bothMatch) // as long as either token matches but both don't match or both tokens are null or both tokens match
                        $("#pair-list").append(currentList[key].fromToken.symbol + "-" + currentList[key].toToken.symbol + "\n<hr>");
                }

                //save new tokens in the list for quicker fetching later
                switch (chain) {
                    case 1:
                        localStorage.tokenlistEth = JSON.stringify(tokenlistEth);
                        break;
                    case 56:
                        localStorage.tokenlistBsc = JSON.stringify(tokenlistBsc);
                        break;
                    case 137:
                        localStorage.tokenlistPoly = JSON.stringify(tokenlistPoly);
                }

            }

            async function loadOrders(orders, chain) {
                $("#orders").empty();
                $("#orders").append("<tr><th>Maker Token</th><th>Taker Token</th><th>Maker Rate</th><th>Taker Rate</th><th>Left To Fill</th></tr>"); //initialize the header
                let currentList = JSON.parse(localStorage.pairs);
                let displayInfo = "";
                let fromToken
                let toToken
                let pair
                let fromTokenSymbol
                let toTokenSymbol
                let toTokenDecimals
                let fromTokenAmount
                let toTokenAmount
                for (var item in orders) {
                    //prepare the pair
                    let success = false;
                    while (!success) {
                        try {
                            fromToken = orders[item].data.makerAsset;
                            toToken = orders[item].data.takerAsset;
                            pair = fromToken + "-" + toToken;
                            fromTokenSymbol = currentList[pair].fromToken.symbol;
                            toTokenSymbol = currentList[pair].toToken.symbol;
                            fromTokenDecimals = currentList[pair].fromToken.decimals;
                            toTokenDecimals = currentList[pair].toToken.decimals;
                            success = true;
                        } catch (e) {
                            currentList = JSON.parse(localStorage.pairs); //re-parse the pairs
                            await delay(1); //keep waiting 
                        }
                    }



                    fromTokenAmount = orders[item].makerAmount;
                    toTokenAmount = orders[item].takerAmount;

                    if (fromTokenDecimals < 18)
                        fromTokenAmount = (fromTokenAmount * Math.pow(10, 18 - fromTokenDecimals))
                    if (toTokenDecimals < 18)
                        toTokenAmount = (toTokenAmount * Math.pow(10, 18 - toTokenDecimals))

                    let makerRate = (fromTokenAmount / toTokenAmount).toFixed(4);
                    let takerRate = (toTokenAmount / fromTokenAmount).toFixed(4);

                    displayInfo = "<tr>";
                    displayInfo += "<td>" + fromTokenSymbol + "</td>"; //add hyperlink
                    displayInfo += "<td>" + toTokenSymbol + "</td>"; //add hyperlink
                    displayInfo += "<td>" + makerRate + "</td>"; //fix this by calculating yourself
                    displayInfo += "<td>" + takerRate + "</td>";
                    displayInfo += "<td>" + (orders[item].remainingMakerAmount / Math.pow(10, fromTokenDecimals)).toFixed(4); + "</td>";
                    displayInfo += "</tr>";
                    $("#orders").append(displayInfo)
                }


            }

            async function loadTokenList(chain) {
                let currentList;
                switch (chain) {
                    case 1:
                        currentList = JSON.parse(localStorage.tokenlistEth);
                        break;
                    case 56:
                        currentList = JSON.parse(localStorage.tokenlistBsc);
                        break;
                    case 137:
                        currentList = JSON.parse(localStorage.tokenlistPoly);
                        break;

                }
                //this is ineficient, why would you do this? 
                $('#toTokenList')[0].innerHTML = "";
                $('#fromTokenList')[0].innerHTML = "";

                for (key in currentList) {


                    $('#toTokenList').append("<option value=\"" + key + "\">" + currentList[key].symbol + "</option>");
                    $('#fromTokenList').append("<option value=\"" + key + "\">" + currentList[key].symbol + "</option>");
                }
            }


            /*
            
            while(true)
            {
                //reload orders
 
                delay(2000) //2 second delay to match polygon
            }
            
            */

        })//end document ready


    </script>



</head>

<body>

    <div id="container">
        <div id="header">
            <div id="header-text">
                <h1>1inch Limit orders</h1>
            </div>

            <div id="chain-select">
                <form id="network-drop-down">
                    <select id="drop-down">
                        <option value="1">1 ETH</option>
                        <option value="56">56 BSC</option>
                        <option value="137">137 MATIC</option>
                    </select>
                </form>
            </div>

            <div id="address-input">
                <form id="address-input-form" style="height:30px">
                    <input type="text" id="address" style="width:250px;" placeholder="Enter an Address"></input>
                </form>
            </div>
        </div>
        <!--<div id="connect-wrapper">
        <button id="connect" target="_blank">Click to connect metamask</button>
        <text> you may need to follow <a style="color:blue"
                href="https://metamask.zendesk.com/hc/en-us/articles/360045901112-How-to-connect-to-a-website-dapp-in-V8-desktop-browser-extension-">this</a>
            guide</text>
        <br>
        <text id="wallet-connected">Wallet connected: none</text>
    </div>
    somehow I want to throw this in the upper right?-->
    </div>

    <div id="body-container">

        <div id="pair-list-style">
            <br />
            <form style="height:30px">
                <input type="text" id="FromToken" style="width:95%; margin:3px;"
                    placeholder="Enter Maker Token Contract" list=fromTokenList>
                <datalist id="fromTokenList">

                </datalist></input>
            </form>

            <form style="height:30px">
                <input type="text" id="ToToken" style="width:95%; margin:3px;" placeholder="Enter Taker Token Contract"
                    list=toTokenList>
                <datalist id="toTokenList">

                </datalist></input>
            </form>
            <form>
                <button id="previous" style="height:30px;width:120px">Previous Page</button>
                <!-- <text id="page-number" style="color:ivory">1</text> -->
                <button id="next" style="height:30px;width:120px">Next Page</button>
            </form>
            <pre style="color:ivory">  This is where a list of pairs 
  on page <text id="page-number" style="color:ivory">1</text> will show up</pre>
            <hr>
            <div id="pair-list">

            </div>
        </div>
        <div id="boxes-table">
            <div id="top-container">
                <div id="top-mid">
                    <div id="chart">
                        //todo https://github.com/1inch/dexcandlesx
                    </div>
                </div>
                <div id="top-right">
                    <pre style="color: ivory">  This is where the spread is displayed</pre>
                    <hr>
                    <div id="spread">

                    </div>
                </div>
            </div>
            <div id="bottom-container">
                <!-- <pre style="color: ivory">  This is where orders will be listed and scrollable hopefully?</pre> -->
                <hr>
                <div>
                    <div id="orders-wrapper">

                        <table id="orders">

                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!--End body-container-->


</body>



<style>
    table {
        width: 100%;
        min-width: 70vw;
    }



    th {
        text-align: left;
    }

    #orders-wrapper {
        position: relative;
        overflow-x: hidden;
        right: -16px;
        /* Increase/Decrease this value for cross-browser compatibility */
        overflow-y: scroll;
        color: ivory;
        word-wrap: break-word;
        max-height: 19vh;
        max-width: 85vw;
    }

    #header-text {
        color: white;
        display: table-cell;
        text-align: left;
        flex: 50%;
        padding-left: 10px;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    #header {
        display: flex;
    }

    #address-input {
        align-content: flex-end;
        margin-top: 30px;
        margin-right: 30px;
        margin-bottom: 30px;
    }

    #chain-select {
        align-content: flex-end;
        margin-top: 30px;
        margin-right: 30px;
        margin-bottom: 30px;
    }

    #boxes-table {
        vertical-align: top;
        width: 100%;
        height: 100%;
    }

    #bottom-container {
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: rgb(19, 29, 39);
        vertical-align: top;
    }

    #top-container {
        margin: 0;
        padding: 0;
        display: table;
        height: 70vh;
        width: 100%;
        vertical-align: top;
    }

    #top-mid {
        display: table-cell;
        position: relative;
        margin: 0;
        padding: 0;
        width: 65vw;
        height: 100%;
        vertical-align: top;
        background-image: linear-gradient(to right, rgba(13, 24, 42), rgba(8, 12, 21), rgba(28, 19, 38));

    }

    #top-right {
        display: table-cell;
        vertical-align: top;
        height: 100%;
        background-color: rgb(7, 14, 20);
    }

    #container {
        vertical-align: top;
        width: 100%;
        height: 100%;
        display: table;
        background-image: linear-gradient(to right, rgba(13, 24, 42), rgba(13, 24, 42), rgba(8, 12, 21), rgba(28, 19, 38), rgba(28, 19, 38));
    }

    #body-container {
        width: 100%;
        height: 100vh;
        display: table;
        vertical-align: top;
        background-color: rgba(20, 24, 33)
    }

    #pair-list-style {
        vertical-align: top;
        display: table-cell;
        overflow: hidden;
        width: 15vw;
        height: 100vh;
        padding: 0;
        margin: 0;
        background-color: rgba(11, 18, 26);
    }

    #pair-list {
        position: relative;
        overflow-x: hidden;
        max-height: 72vh;
        overflow-y: scroll;
        color: ivory;
        font-family: monospace;
    }


    #chart {
        display: flex;
        color: ivory;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    body {
        vertical-align: top;
        padding: 0;
        margin: 0px;
        overflow: hidden;
    }
</style>

</html>
