<!DOCTYPE html>
<html>

<head>
    <script type="text/json"
        src="https://cdn.jsdelivr.net/npm/@1inch/limit-order-protocol@1.3.0/abi/LimitOrderProtocol.json"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.6/dist/web3.min.js" type="text/javascript"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>

    <script async>

        localStorage.setItem("page", 1);
        !(localStorage.getItem("pairs") == null) ? null : localStorage.setItem("pairs", "{}");

        let chain = 1; //it's 1 by default
        let tokenlist;
        let provider;
        let signer;
        let abi = "";

        //run this on page load
        let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/all?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%2C2%2C3%5D&sortBy=takerRate&takerAsset=&makerAsset="; //unspecified tokens to just load "random" orders
        $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
            //console.log(ret);
            loadPairs(ret, chain);
        })

        async function loadPairs(orders, chain) {

            let currentList = JSON.parse(localStorage.pairs);

            let tokenInfo = "";
            let url = "";
            let fromToken;
            let toToken;
            for (var i = 0; i < orders.length; i++) {
                //if ((fromToken != orders[i].data.makerAsset || toToken != orders[i].data.takerAsset) || tokenInfo === "") {
                orderInfo = ""; //this will be used to display on orders
                pairInfo = ""; //this will be used to display on the pair-list
                if (fromToken != orders[i].data.makerAsset) {
                    fromToken = orders[i].data.makerAsset;
                }
                if (toToken != orders[i].data.takerAsset) {
                    toToken = orders[i].data.takerAsset;
                }


                let pair = fromToken + "-" + toToken;

                if (!(currentList.hasOwnProperty(pair))) {
                    currentList[pair] = pair; //should make this the symbol
                }


            }
            //save all the *new* pairs
            localStorage.setItem('pairs', JSON.stringify(currentList));
            for (const key in currentList) {
                console.log("adding pair");
                $("#pair-list").append(currentList[key] + "\n<hr>");
            }
        }


        $(() => {

            $('#next').on('click', (e) => {
                e.preventDefault();
                localStorage.setItem("page", Number.parseInt(localStorage.getItem("page")) + 1);
                $('#page-number').text(localStorage.getItem("page"));
            })
            $('#previous').on('click', (e) => {
                e.preventDefault();

                if (localStorage.getItem("page") > 1)
                    localStorage.setItem("page", Number.parseInt(localStorage.getItem("page")) - 1);
                $('#page-number').text(localStorage.getItem("page"));
            })


            $('#search-btn').on('click', (e) => {
                e.preventDefault(); //*CRITICAL* : this "catches" the form submit event and stops it

                async function driver() {
                    let fromToken = document.getElementById("FromToken").value;
                    let toToken = document.getElementById("ToToken").value;

                    let address = document.getElementById("address").value;

                    chain = document.getElementById("drop-down").value;

                    $('#results').text(""); //delete results
                    try {
                        await $.ajax({ method: "GET", url: "https://apiv4.paraswap.io/v2/tokens/" + chain }).done((ret) => {
                            tokenlist = ret.tokens;
                        })
                    }
                    catch (e) {
                        //tokenlist fallback
                        try {
                            await $.ajax({ method: "GET", url: "https://tokens.1inch.exchange/v1.1/" + chain }).done((ret) =>
                                tokenlist = ret)
                        } catch (e) {
                            alert("an error has occured, orders may not load");
                        }
                    }

                    if (fromToken != "" || toToken != "") {
                        getLOPairList(fromToken, toToken, chain); //get new results
                    }
                    if (address != "")
                        getAddressLOList(address, chain)


                }

                function getLOPairList(fromToken, toToken, chain) {
                    let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/all?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%2C2%2C3%5D&sortBy=takerRate&takerAsset=" + toToken + "&makerAsset=" + fromToken;
                    $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                        //console.log(ret);
                        parseLOPairResults(ret, fromToken, toToken, chain);
                    })

                }

                async function parseLOPairResults(orders, fromToken, toToken, chain) {

                    let tokenInfo = "";
                    let url = "";
                    let fromTokenIndex = -2;
                    let toTokenIndex = -2;
                    for (var i = 0; i < orders.length; i++) {
                        //if ((fromToken != orders[i].data.makerAsset || toToken != orders[i].data.takerAsset) || tokenInfo === "") {
                        displayInfo = "";
                        fromTokenIndex = -1;
                        toTokenIndex = -1;
                        if (fromToken != orders[i].data.makerAsset) {
                            fromToken = orders[i].data.makerAsset;
                        }
                        if (toToken != orders[i].data.takerAsset) {
                            toToken = orders[i].data.takerAsset;
                        }





                        try {
                            url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=' + orders[i].makerAmount;


                            await $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                                tokenInfo = ret;

                                let toTokenInfo = orders[i].data.takerAsset == ret.fromToken.address ? ret.fromToken : ret.toToken;
                                let fromTokenInfo = orders[i].data.makerAsset == ret.toToken.address ? ret.toToken : ret.fromToken;

                                displayInfo += "MakerAmount: " + (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)).toFixed(fromTokenInfo.decimals > 4 ? 4 : 0) + " " + fromTokenInfo.symbol + "\n";
                                displayInfo += "TakerAmount: " + (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)).toFixed(toTokenInfo.decimals > 4 ? 4 : 0) + " " + toTokenInfo.symbol + "\n";
                                let makerRate = (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)) / (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals));
                                let takerRate = (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)) / (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals));
                                displayInfo += "TakerRate: " + takerRate + " " + toTokenInfo.symbol + " per 1 " + fromTokenInfo.symbol + "\n";
                                displayInfo += "MakerRate: " + makerRate + " " + fromTokenInfo.symbol + " per 1 " + toTokenInfo.symbol + "\n";

                                displayInfo += "Left to Fill: ";
                                displayInfo += orders[i].remainingMakerAmount / Math.pow(10, fromTokenInfo.decimals) + " " + fromTokenInfo.symbol + "\n"

                                $('#results').append(displayInfo + '<hr>');
                            })


                        }
                        catch (e) {
                            //alert("Flipping")
                            try {
                                url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?fromTokenAddress=' + toToken + '&toTokenAddress=' + fromToken + '&amount=' + orders[i].makerAmount;
                                await $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                                    tokenInfo = ret;

                                    let fromTokenInfo = orders[i].data.makerAsset == ret.toToken.address ? ret.toToken : ret.fromToken;
                                    let toTokenInfo = orders[i].data.takerAsset == ret.fromToken.address ? ret.fromToken : ret.toToken;

                                    displayInfo += "MakerAmount: " + (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)).toFixed(fromTokenInfo.decimals > 4 ? 4 : 0) + " " + fromTokenInfo.symbol + "\n";
                                    displayInfo += "TakerAmount: " + (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)).toFixed(toTokenInfo.decimals > 4 ? 4 : 0) + " " + toTokenInfo.symbol + "\n";
                                    let makerRate = (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)) / (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals));
                                    let takerRate = (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)) / (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals));
                                    displayInfo += "MakerRate: " + makerRate + " " + toTokenInfo.symbol + " per 1 " + fromTokenInfo.symbol + "\n";
                                    displayInfo += "TakerRate: " + takerRate + " " + fromTokenInfo.symbol + " per 1 " + toTokenInfo.symbol + "\n";

                                    displayInfo += "Left to Fill: ";
                                    displayInfo += orders[i].remainingMakerAmount / Math.pow(10, fromTokenInfo.decimals) + " " + fromTokenInfo.symbol + "\n"

                                    $('#results').append(displayInfo + '<hr>');

                                })
                            } catch (e) { $('#results').append("Unable to find token info for " + toToken + " to " + fromToken + '<hr>'); }
                        }
                        // } else {
                        //     displayInfo = "";
                        //     let fromTokenInfo = orders[i].data.takerAsset == tokenInfo.fromToken.address ? tokenInfo.fromToken : tokenInfo.toToken;
                        //     let toTokenInfo = orders[i].data.makerAsset == tokenInfo.toToken.address ? tokenInfo.toToken : tokenInfo.fromToken;

                        //     displayInfo += "MakerAmount: " + (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)).toFixed(fromTokenInfo.decimals > 4 ? 4 : 0) + " " + fromTokenInfo.symbol + "\n";
                        //     displayInfo += "TakerAmount: " + (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)).toFixed(fromTokenInfo.decimals > 4 ? 4 : 0) + " " + toTokenInfo.symbol + "\n";
                        //     let makerRate = (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals)) / (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals));
                        //     let takerRate = (orders[i].makerAmount / Math.pow(10, fromTokenInfo.decimals)) / (orders[i].takerAmount / Math.pow(10, toTokenInfo.decimals));
                        //     displayInfo += "MakerRate: " + makerRate + " " + toTokenInfo.symbol + " per 1 " + fromTokenInfo.symbol + "\n";
                        //     displayInfo += "TakerRate: " + takerRate + " " + fromTokenInfo.symbol + " per 1 " + toTokenInfo.symbol + "\n";

                        //     displayInfo += "Left to Fill: ";
                        //     displayInfo += orders[i].remainingMakerAmount / Math.pow(10, fromTokenInfo.decimals) + " " + fromTokenInfo.symbol + "\n"

                        //     $('#results').append(displayInfo + '<hr>');
                        // }
                    }

                }

                function getAddressLOList(address, chain) {
                    let url = "https://limit-orders.1inch.exchange/v1.0/" + chain + "/limit-order/address/" + address + "?page=" + localStorage.getItem("page") + "&limit=100&statuses=%5B1%2C2%5D"
                    $.ajax({ method: "GET", dataType: "json", url: url }).done((ret) => {
                        console.log(ret);
                        parseAddressLOResults(ret, address, chain);
                    })
                }

                async function parseAddressLOResults(orders, address, chain) {
                    let fromToken;
                    let toToken;
                    let url = 'https://api.1inch.exchange/v3.0/' + chain + '/quote?' //'fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=1000000000000000000'
                    let tokenInfo;

                    let scan = getBlockchainScannerForToken(chain);

                    for (let i = 0; i < orders.length; i++) {


                        //if (fromToken != orders[i].data.makerAsset && toToken != orders[i].data.takerAsset) {
                        if (fromToken != orders[i].data.makerAsset)
                            fromToken = orders[i].data.makerAsset;
                        if (toToken != orders[i].data.takerAsset)
                            toToken = orders[i].data.takerAsset;
                        try {
                            if (tokenlist[tokenlist.findIndex(item => item.address === orders[i].data.makerAsset)].decimals < 18) //if the maker token has less than 18 dcimals
                                orders[i].remainingMakerAmount = (orders[i].remainingMakerAmount * Math.pow(10, 18 - orders[i].fromTokenInfo.decimals)); //pad until 18 decimals
                        } catch (e) {
                            console.log("Can't pad, assuming makerAmount has 18 decimals");
                        }

                        if ( //if offerRecieve fails, try the next
                            await offerRecieve(url, toToken, fromToken, orders[i].remainingMakerAmount, orders[i], scan)
                        ) {
                            if (
                                await offerRecieveFlipped(url, toToken, fromToken, orders[i].remainingMakerAmount, orders[i], scan)
                            ) {
                                $('#results').append("Unable to find token info for " + toToken + " to " + fromToken + '<hr>');
                            }
                        }
                    }
                }

                async function offerRecieve(url, toToken, fromToken, amount, orderData, chainURL) {
                    let displayInfo = "";
                    try {
                        await $.ajax({ method: "GET", dataType: "json", url: url + 'fromTokenAddress=' + toToken + '&toTokenAddress=' + fromToken + '&amount=' + amount }).done((ret) => {
                            console.log(ret);
                            tokenInfo = ret;

                            displayInfo += "Your Offer: " + (orderData.takerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                                + " <a href=\"" + chainURL + toToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                            displayInfo += "You Recieve: " + (orderData.makerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                                + " <a href=\"" + chainURL + fromToken + "\">" + tokenInfo.toToken.symbol + "</a>" + "\n";

                            displayInfo += "Left to Fill: " + amount / Math.pow(10, tokenInfo.fromToken.decimals) + " " + tokenInfo.fromToken.symbol + "\n";
                            //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orderData.data) + ">Cancel order?</button>\n";

                            $('#results').append(displayInfo + '<hr>');
                        })
                    }
                    catch (e) {
                        return true; //return true upon failure
                    }
                    return false; //return false if it works
                }

                async function offerRecieveFlipped(url, toToken, fromToken, amount, orderData, chainURL) {
                    let displayInfo = "";
                    console.log("Flipping quote");
                    try {
                        await $.ajax({ method: "GET", dataType: "json", url: url + 'fromTokenAddress=' + fromToken + '&toTokenAddress=' + toToken + '&amount=' + amount }).done((ret) => {
                            console.log(ret);
                            tokenInfo = ret;

                            displayInfo += "Your Offer: " + (orderData.makerAmount / Math.pow(10, tokenInfo.fromToken.decimals))
                                + " <a href=\"" + chainURL + toToken + "\">" + tokenInfo.fromToken.symbol + "</a>" + "\n";
                            displayInfo += "You Recieve: " + (orderData.takerAmount / Math.pow(10, tokenInfo.toToken.decimals))
                                + " <a href=\"" + chainURL + fromToken + "\">" + tokenInfo.toToken.symbol + "</a>" + "\n";


                            displayInfo += "Left to Fill: " + amount / Math.pow(10, tokenInfo.fromToken.decimals) + " " + tokenInfo.fromToken.symbol + "\n";
                            //displayInfo += "<button onClick=\"cancelOrder(this.value)\" value=" + JSON.stringify(orderData.data) + ">Cancel order?</button>\n";

                            $('#results').append(displayInfo + '<hr>');
                        })
                    } catch (e) {
                        return true; //return true upon failure
                    }
                    return false; //return false if it works
                }

                function getBlockchainScannerForToken(chain) {
                    switch (chain) {
                        case "1": return "https://etherscan.io/token/"
                            break;
                        case "56": return "https://bscscan.com/token/"
                            break;
                        case "137": return "https://polygonscan.com/token/"
                            break;
                    }
                }

                driver();
            })
        })//end search-btn



    </script>



</head>

<body>

    <div id="container">
        <div id="header">
            <div id="header-text">
                <h1>1inch Limit orders</h1>
            </div>

            <div id="chain-select">
                <form id="network-drop-down">
                    <select id="drop-down">
                        <option value="1">1 ETH</option>
                        <option value="56">56 BSC</option>
                        <option value="137">137 MATIC</option>
                    </select>
                </form>
            </div>

            <div id="address-input">
                <form id="address-input-form" style="height:30px">
                    <input type="text" id="address" style="width:250px;" placeholder="Enter an Address"></input>
                </form>
            </div>
        </div>
        <!--<div id="connect-wrapper">
        <button id="connect" target="_blank">Click to connect metamask</button>
        <text> you may need to follow <a style="color:blue"
                href="https://metamask.zendesk.com/hc/en-us/articles/360045901112-How-to-connect-to-a-website-dapp-in-V8-desktop-browser-extension-">this</a>
            guide</text>
        <br>
        <text id="wallet-connected">Wallet connected: none</text>
    </div>
    somehow I want to throw this in the upper right?-->
    </div>

    <div id="body-container">
        <div id="pair-list-style">
            <form style="height:30px">
                <input type="text" id="FromToken" style="width:95%; margin:3px;"
                    placeholder="Enter From Token Contract"></input>
            </form>

            <form style="height:30px">
                <input type="text" id="ToToken" style="width:95%; margin:3px;"
                    placeholder="Enter To Token Contract"></input>
            </form>
            <form>
                <button id="previous" style="height:30px;width:120px">Previous Page</button>
                <!-- <text id="page-number" style="color:ivory">1</text> -->
                <button id="next" style="height:30px;width:120px">Next Page</button>
            </form>
            <pre style="color:ivory">  This is where a list of pairs 
  on page <text id="page-number" style="color:ivory">1</text> will show up</pre>
            <hr>
            <div id="pair-list">

            </div>
        </div>
        <div id="boxes-table">
            <div id="top-container">
                <div id="top-mid">
                    <div id="chart">
                        //todo https://github.com/1inch/dexcandlesx
                    </div>
                </div>
                <div id="top-right">
                    <pre style="color: ivory">  This is where the spread is displayed</pre>
                    <hr>
                    <div id="spread">

                    </div>
                </div>
            </div>
            <div id="bottom-container">
                <pre style="color: ivory">  This is where orders will be listed and scrollable hopefully?</pre>
                <hr>
                <div id="orders">

                </div>
            </div>
        </div>

    </div>
    <!--End body-container-->


</body>



<style>
    #orders {
        position: relative;
        overflow-x: hidden;
        right: -16px;
        /* Increase/Decrease this value for cross-browser compatibility */
        overflow-y: scroll;
        color: ivory;
        word-wrap: break-word;
        max-height: 15vh;
        max-width: 85vw;
    }

    #header-text {
        color: white;
        display: table-cell;
        text-align: left;
        flex: 50%;
        padding-left: 10px;
        font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
    }

    #header {
        display: flex;
    }

    #address-input {
        align-content: flex-end;
        margin-top: 30px;
        margin-right: 30px;
        margin-bottom: 30px;
    }

    #chain-select {
        align-content: flex-end;
        margin-top: 30px;
        margin-right: 30px;
        margin-bottom: 30px;
    }

    #boxes-table {
        vertical-align: top;
        width: 100%;
        height: 100%;
    }

    #bottom-container {
        position: absolute;
        height: 100%;
        width: 100%;
        background-color: rgb(19, 29, 39);
        vertical-align: top;
    }

    #top-container {
        margin: 0;
        padding: 0;
        display: table;
        height: 70vh;
        width: 100%;
        vertical-align: top;
    }

    #top-mid {
        display: table-cell;
        position: relative;
        margin: 0;
        padding: 0;
        width: 65vw;
        height: 100%;
        vertical-align: top;
        background-image: linear-gradient(to right, rgba(13, 24, 42), rgba(8, 12, 21), rgba(28, 19, 38));

    }

    #top-right {
        display: table-cell;
        vertical-align: top;
        height: 100%;
        background-color: rgb(7, 14, 20);
    }

    #container {
        vertical-align: top;
        width: 100%;
        height: 100%;
        display: table;
        background-image: linear-gradient(to right, rgba(13, 24, 42), rgba(13, 24, 42), rgba(8, 12, 21), rgba(28, 19, 38), rgba(28, 19, 38));
    }

    #body-container {
        width: 100%;
        height: 100vh;
        display: table;
        vertical-align: top;
        background-color: rgba(20, 24, 33)
    }

    #pair-list-style {
        display: table-cell;
        overflow: hidden;
        width: 15vw;
        height: 100vh;
        padding: 0;
        margin: 0;
        background-color: rgba(11, 18, 26);
    }

    #pair-list {
        position: relative;
        overflow-x: hidden;
        max-height: 72vh;
        overflow-y: scroll;
        color: ivory;
        font-family: monospace;
    }


    #chart {
        display: flex;
        color: ivory;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    body {
        vertical-align: top;
        padding: 0;
        margin: 0px;
        overflow: hidden;
    }
</style>

</html>